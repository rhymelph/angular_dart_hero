define(['dart_sdk', 'packages/package_config/src/util'], function(dart_sdk, packages__package_config__src__util) {
  'use strict';
  const core = dart_sdk.core;
  const _js_helper = dart_sdk._js_helper;
  const dart = dart_sdk.dart;
  const dartx = dart_sdk.dartx;
  const util = packages__package_config__src__util.src__util;
  const packages_file = Object.create(dart.library);
  const $length = dartx.length;
  const $_get = dartx._get;
  const $isEmpty = dartx.isEmpty;
  const $endsWith = dartx.endsWith;
  const $containsKey = dartx.containsKey;
  const $_set = dartx._set;
  const $split = dartx.split;
  const $last = dartx.last;
  const $removeLast = dartx.removeLast;
  const $forEach = dartx.forEach;
  const $toLowerCase = dartx.toLowerCase;
  const $toList = dartx.toList;
  const $isNotEmpty = dartx.isNotEmpty;
  const $skip = dartx.skip;
  const $join = dartx.join;
  const $times = dartx['*'];
  let IdentityMapOfString$Uri = () => (IdentityMapOfString$Uri = dart.constFn(_js_helper.IdentityMap$(core.String, core.Uri)))();
  let StringAndUriToNull = () => (StringAndUriToNull = dart.constFn(dart.fnType(core.Null, [core.String, core.Uri])))();
  let ListOfString = () => (ListOfString = dart.constFn(core.List$(core.String)))();
  const CT = Object.create(null);
  packages_file.parse = function parse(source, baseLocation, opts) {
    let t0, t0$;
    let allowDefaultPackage = opts && 'allowDefaultPackage' in opts ? opts.allowDefaultPackage : false;
    let index = 0;
    let result = new (IdentityMapOfString$Uri()).new();
    while (index < dart.notNull(source[$length])) {
      let isComment = false;
      let start = index;
      let separatorIndex = -1;
      let end = source[$length];
      let char = source[$_get]((t0 = index, index = t0 + 1, t0));
      if (char === 13 || char === 10) {
        continue;
      }
      if (char === 58) {
        if (!dart.test(allowDefaultPackage)) {
          dart.throw(new core.FormatException.new("Missing package name", source, index - 1));
        }
        separatorIndex = index - 1;
      }
      isComment = char === 35;
      while (index < dart.notNull(source[$length])) {
        char = source[$_get]((t0$ = index, index = t0$ + 1, t0$));
        if (char === 58 && separatorIndex < 0) {
          separatorIndex = index - 1;
        } else if (char === 13 || char === 10) {
          end = index - 1;
          break;
        }
      }
      if (isComment) continue;
      if (separatorIndex < 0) {
        dart.throw(new core.FormatException.new("No ':' on line", source, index - 1));
      }
      let packageName = core.String.fromCharCodes(source, start, separatorIndex);
      if (packageName[$isEmpty] ? !dart.test(allowDefaultPackage) : !dart.test(util.isValidPackageName(packageName))) {
        dart.throw(new core.FormatException.new("Not a valid package name", packageName, 0));
      }
      let packageValue = core.String.fromCharCodes(source, separatorIndex + 1, end);
      let packageLocation = null;
      if (packageName[$isEmpty]) {
        if (!dart.test(util.isValidPackageName(packageValue))) {
          dart.throw(new core.FormatException.new("Default package entry value is not a valid package name"));
        }
        packageLocation = core._Uri.new({path: packageValue});
      } else {
        packageLocation = baseLocation.resolve(packageValue);
        if (!packageLocation.path[$endsWith]("/")) {
          packageLocation = packageLocation.replace({path: dart.notNull(packageLocation.path) + "/"});
        }
      }
      if (dart.test(result[$containsKey](packageName))) {
        if (packageName[$isEmpty]) {
          dart.throw(new core.FormatException.new("More than one default package entry", source, start));
        }
        dart.throw(new core.FormatException.new("Same package name occured twice", source, start));
      }
      result[$_set](packageName, packageLocation);
    }
    return result;
  };
  packages_file.write = function write(output, packageMapping, opts) {
    let baseUri = opts && 'baseUri' in opts ? opts.baseUri : null;
    let comment = opts && 'comment' in opts ? opts.comment : null;
    if (baseUri != null && !dart.test(baseUri.isAbsolute)) {
      dart.throw(new core.ArgumentError.value(baseUri, "baseUri", "Must be absolute"));
    }
    if (comment != null) {
      let lines = comment[$split]("\n");
      if (lines[$last][$isEmpty]) lines[$removeLast]();
      for (let commentLine of lines) {
        output.write("# ");
        output.writeln(commentLine);
      }
    } else {
      output.write("# generated by package:package_config at ");
      output.write(new core.DateTime.now());
      output.writeln();
    }
    packageMapping[$forEach](dart.fn((packageName, uri) => {
      if (!dart.test(util.isValidPackageName(packageName))) {
        dart.throw(new core.ArgumentError.new("\"" + dart.str(packageName) + "\" is not a valid package name"));
      }
      if (uri.scheme === "package") {
        dart.throw(new core.ArgumentError.value("Package location must not be a package: URI", dart.toString(uri)));
      }
      output.write(packageName);
      output.write(":");
      if (baseUri != null) {
        uri = packages_file._relativize(uri, baseUri);
      }
      output.write(uri);
      if (!uri.path[$endsWith]("/")) {
        output.write("/");
      }
      output.writeln();
    }, StringAndUriToNull()));
  };
  packages_file._relativize = function _relativize(uri, baseUri) {
    let t0;
    if (!dart.test(baseUri.isAbsolute)) dart.assertFailed(null, "org-dartlang-app:///packages/package_config/packages_file.dart", 159, 10, "baseUri.isAbsolute");
    if (dart.test(uri.hasQuery) || dart.test(uri.hasFragment)) {
      uri = core._Uri.new({scheme: uri.scheme, userInfo: dart.test(uri.hasAuthority) ? uri.userInfo : null, host: dart.test(uri.hasAuthority) ? uri.host : null, port: dart.test(uri.hasAuthority) ? uri.port : null, path: uri.path});
    }
    if (!dart.test(uri.isAbsolute)) return uri;
    if (baseUri.scheme != uri.scheme) {
      return uri;
    }
    if (!dart.equals(uri.hasAuthority, baseUri.hasAuthority)) return uri;
    if (dart.test(uri.hasAuthority)) {
      if (uri.userInfo != baseUri.userInfo || uri.host[$toLowerCase]() !== baseUri.host[$toLowerCase]() || uri.port != baseUri.port) {
        return uri;
      }
    }
    baseUri = baseUri.normalizePath();
    let base = baseUri.pathSegments[$toList]();
    if (dart.test(base[$isNotEmpty])) {
      base = (t0 = ListOfString().from(base), t0[$removeLast](), t0);
    }
    uri = uri.normalizePath();
    let target = uri.pathSegments[$toList]();
    if (dart.test(target[$isNotEmpty]) && target[$last][$isEmpty]) target[$removeLast]();
    let index = 0;
    while (index < dart.notNull(base[$length]) && index < dart.notNull(target[$length])) {
      if (base[$_get](index) != target[$_get](index)) {
        break;
      }
      index = index + 1;
    }
    if (index === base[$length]) {
      if (index === target[$length]) {
        return core._Uri.new({path: "./"});
      }
      return core._Uri.new({path: target[$skip](index)[$join]("/")});
    } else if (index > 0) {
      return core._Uri.new({path: "../"[$times](dart.notNull(base[$length]) - index) + dart.notNull(target[$skip](index)[$join]("/"))});
    } else {
      return uri;
    }
  };
  dart.trackLibraries("packages/package_config/packages_file", {
    "package:package_config/packages_file.dart": packages_file
  }, {
  }, '{"version":3,"sourceRoot":"","sources":["packages_file.dart"],"names":[],"mappings":"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","file":"packages_file.ddc.js"}');
  // Exports:
  return {
    packages_file: packages_file
  };
});

//# sourceMappingURL=packages_file.ddc.js.map
